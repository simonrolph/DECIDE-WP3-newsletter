---
title: "Send_emails via Rstudio Connect to access SMTP server"
author: "Simon Rolph"
output: html_document
resource_files:
  - "newsletters/2022-07-21"
---


## Introduction



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparatory steps

Generated newsletters (in html format) must be downloaded from JASMIN and placed into a folder with the format `newsletters/{DATE}/`. This file path must then udpated in the `resource_files:` part of the YAML header above before deploying.

## Set up and load data

Load pacakges

```{r}
library(blastula)
library(magrittr)

creds <- creds_anonymous(host = "smtp.nerc-lancaster.ac.uk",port=25,use_ssl = T)

```

Load the emails data frame

```{r}
emails <- readRDS("data_personal/emails_2022-08-03.rds") # UPDATE THIS TO THE LASTEST FILE

#adapt the filepaths to work on rsconnect
for (i in 1:nrow(emails)){
  emails$newsletter_file_location[i] <- gsub("C:/Users/simrol/Documents/R/DECIDE-WP3-newsletter/","", emails$newsletter_file_location[i])
}

```

## Preflight checks

Will abort if any identities are incorrect

```{r}
for (i in 1:nrow(emails)){
  #print(i)
  if(file.exists(emails$newsletter_file_location[i])){
    
    #file found, checking identity
    identity_check <- readLines(emails$newsletter_file_location[i],encoding = "UTF-8") %>% 
      paste0(collapse="") %>% 
      gsub("â€™","'",.) %>% #circumvent encoding issue
      grepl(emails$name[i],.)
    
    
    if(!identity_check){
      #if there's an error then abort completely
      print(emails$newsletter_file_location[i]) #what file
      
      print("Expected name:")
      print(emails$name[i]) #what name
      
      print("Opening html for viewing")
      shell.exec(emails$newsletter_file_location[i]) #open file
      
      stop("Identity incorrect for an email. Aborting operation.") #stop
      knitr::knit_exit() #backup stop
    }
    
  } else {
    #indicate if a file is missing but don't abort
    print("File missing:")
    print(emails$newsletter_file_location[i]) #what file
    #missing file
  }
}


#manual visual check
for (i in 1:nrow(emails)){
  if(file.exists(emails$newsletter_file_location[i])){
    shell.exec(emails$newsletter_file_location[i]) #open file
    Sys.sleep(1)
  }
}



#check are there any duplicates
unique_test <- list.files("newsletters/2022-08-03/") %>%
  paste0("newsletters/2022-08-03/",.) %>%
  sapply(readLines,encoding = "UTF-8") %>%
  sapply(paste0,collapse="")

if(length(unique_test) != length(unique(unique_test))){
  stop("Duplicate emails detected! Aborting operation.")
}



# file size the same?
file_size_test <- list.files("newsletters/2022-08-03/") %>%
  paste0("newsletters/2022-08-03/",.) %>%
  sapply(function(x){file.info(x)$size})

length(file_size_test)
length(unique(file_size_test))

#view which ones have duplciated file sizes, they're all data story 5 which are very similar anyway so that is expected
file_size_test[duplicated(file_size_test)]

```


## Sending emails

Loop through and send the emails

```{r}

#loop through each email and send it
for (i in 1:nrow(emails)){
  print(i)

  #define sender and recipient (could change this for testing, eg. set the recipient to your email to generate a batch of emails for different users but then see what they look like in your own inbox without spamming real users.)
  sender <- "DECIDE@ceh.ac.uk"

  if(file.exists(emails$newsletter_file_location[i])){

    #final identity check (does the name of the person appear in the email content)
    identity_check <- readLines(emails$newsletter_file_location[i]) %>% paste0(collapse="") %>% grepl(emails$name[i],.)

    if(identity_check){
      # turn the rendered markdown into a blastula ready email object
      email_obj <- blastula:::cid_images(emails$newsletter_file_location[i])

      print("sending to: ")
      print(c(emails$email[i]))

      #send email
      smtp_send(email_obj,
                from = sender,
                to = c(emails$email[i]),
                #to = "simrol@ceh.ac.uk",
                subject = "MyDECIDE",
                credentials = creds,
                verbose = F
      )

    } else {
      print(i)
      print("Identity not match, not sending email")
    }

    Sys.sleep(0.25)
  } else {
    print("file not found. Email not sent.")
  }

}

#delete all the files
#sapply(emails$newsletter_file_location, unlink)

```